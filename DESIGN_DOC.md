# Design Doc

## Objective

消防点検業務においては、現在大きく分けて二つの課題がある。

### 課題1: 当日中に点検業務の結果を報告できないこと
- 手書きの複写式、口頭で伝えるのような、不良個所一覧表に手書きで修正して渡すという方法で報告している。
- メールで報告書のpdfを送るのでも大丈夫
- ハンディプリンタで印刷するが理想

### 課題2: 点検業務と点検作業の両方で手を使う必要があり、効率的な点検業務遂行作業のボトルネックとなっていること
- 紙ベースのものに内容を記載しながら
- 片手が埋まってしまうので作業が止まってしまう。
- 音声を利用して省力化できるのではないか。

これらを改善するために消防点検業務DXアプリケーションを開発する。

## Goal / Non-goal

### Goals
- 点検結果を図面上のアイコンをタップすることで記載可能なUI
- アイコンタップ後には、音声認識での入力と、画面での入力に対応
- 消防点検報告書の半自動作成
- 一時的にタブレットが圏外になったとしてもアプリケーションを操作可能

### Non-goals
- すべての入力を音声認識で行う(手をつかうこともある)
- 消防点検設備のいっせいコピー

## Discussion

### 感知器の細かな種類とかどこまで必要なのか?
- グリーンのものと、防水型
- 必要なものをメールで送ってもらう。

### 案件ごとに建物を管理すべき?
- 現在の管理形態を知りたい。
- 同一顧客が複数の案件を持つ場合もある?
- 案件ごとに建物が複数ある?
- (例)病院の法人さん
- 報告自体は建物ごと
- 建物に対してどこの法人さんなのかを入れれたらいい。

### 消防点検設備が同一の建物が結構存在する?
- 消防点検設備のいっせいコピーとかできる必要がある?
- 一つの建物の中で、2～8階は同じみたいなことはある。
- 一旦はなくても大丈夫

### 複数人で編集したいか、それとも、完全オフラインで利用したいか
- 複数人で編集したいか
  - -> 項目を分担して点検することがあるため、点検の最後には少なくともマージしたい。
  - 火災報知器という同一項目の点検を手分けする場合もある。

### ネットワークにつなぐことが可能かどうか
- ポケットwifiを持って行くことは可能?
- ポケットwifiを一台持ち込んで、そこにすべてのタブレットをつなぐ、オンラインに戻ったらアップする。
- 音声認識ではオフラインでは動作しない、もしくは性能が低下する。
- 5人6人ぐらいで分担して点検する。2人3人はタブレットを持ってて欲しい。

## Architecture

### 技術スタック

**フロントエンド**
- **ビルドツール**: Vite
- **フレームワーク**: React 18+ (TypeScript)
- **状態管理**: Zustand (詳細は [ADR-001](docs/ADR-001-state-management.md) 参照)
- **UIライブラリ**: Tailwind CSS
- **ルーティング**: React Router v6
- **フォーム管理**: React Hook Form + Zod
- **図面操作**: react-zoom-pan-pinch (パン・ズーム機能)
- **PDF処理**: PDF.js (ブラウザ側でPDFをPNGに変換)
- **日付処理**: date-fns
- **アイコン**: lucide-react
- **リンター/フォーマッター**: ESLint + Prettier

**バックエンド/インフラ**
- **認証**: Firebase Authentication
- **DB**: Firebase Firestore
- **ストレージ**: Firebase Cloud Storage
- **音声入力**: Google Gemini マルチモーダルAPI
- **ホスティング**: Firebase Hosting

**PWA機能**
- **Service Worker**: Workbox
- **オフラインストレージ**: IndexedDB (Zustand persist middleware)
- **キャッシュ戦略**: Network First with Cache Fallback

**開発環境**
- **言語**: TypeScript
- **パッケージマネージャー**: pnpm
- **バージョン管理**: Git
- **テストフレームワーク**: Vitest
- **テスト配置**: 各階層に `__tests__` フォルダ

## 画面遷移・ユーザーフロー

### 基本フロー (点検者)
1. **ログイン** (メール + パスワード)
2. **案件一覧** (自社の案件のみ表示)
3. **案件選択** → 案件詳細/編集ページ
   - 案件情報の編集 (管理者のみ)
   - 図面PDFのアップロード (管理者のみ)
   - 点検イベントの作成/選択
4. **点検イベント作成/選択**
   - 新規作成: 点検日、点検者名などを入力
   - 既存選択: 過去の点検イベントから選択して編集継続
5. **図面表示** (連続ページビュー)
   - PDF1ページ1 → PDF1ページ2 → PDF2ページ1 → PDF2ページ2...
   - スワイプまたはボタンでページ切り替え
6. **点検作業** (点検モード/設備配置モード切り替え可能)

### 管理者フロー
1. **ログイン** (メール + パスワード)
2. **ダッシュボード**
   - 案件一覧
   - ユーザー管理へのリンク
   - 進行中の点検イベント一覧
3. **ユーザー管理画面** (管理者のみ)
   - ユーザー一覧表示
   - ユーザー新規作成
   - ユーザー編集 (権限変更、有効/無効)
   - ユーザー削除
4. **案件管理** (通常フローと同じ)

### 案件編集ページ
- **案件情報編集**: 顧客名、住所など
- **図面管理**: PDFアップロード、削除、並び替え
- **点検イベント管理**: 新規作成、過去イベント一覧

### 図面表示ページ(点検作業画面)
- **モード切り替えボタン**: 点検モード ⇔ 設備配置モード
- **ページナビゲーション**: 前へ/次へボタン、ページ番号表示
- **図面**: PDF各ページをPNG変換して表示(連続管理)

## UI/UX 仕様

### 図面上のアイコン表示
- **未点検**: 黒色
- **点検済み(正常)**: 緑色
- **点検済み(異常あり)**: 赤色
- **複数記録あり**: 黄色い△マーク表示

### 操作方法
- **点検入力**: 図面上のアイコンをタップして入力画面を表示
- **音声入力**:
  - Gemini マルチモーダルAPIを使用
  - 音声を直接入力し、AIが自動的に適切な点検項目へ振り分け
  - 正常/異常の判定も自動で行う
  - 音声ファイルは保存せず、認識結果(テキスト + 判定結果)のみ保存
  - **オンライン環境必須**(オフラインでは使用不可)
- **手入力**: 通常のテキスト入力フォーム(各点検項目ごとに入力)
- **編集**: アイコンを再度タップして編集可能
- **図面操作**: パン(移動)、ズーム機能あり

### モード切り替え
- **点検モード**: 点検結果の入力・編集(デフォルト)
- **設備配置モード**: アイコンの配置・設定(ボタンで切り替え)
  - 点検者全員が使用可能
  - 点検中でも設備配置の追加・編集が可能

## 報告書生成

### フォーマット
- **形式**:
  - Excel (xlsm) - 18ファイル
  - Word (doc/docx) - 約43ファイル
- **テンプレート**: 国が定めた固定フォーマットを使用
- **Excel種類**: 18種類の設備に対応
  - 自動火災報知設備
  - 消火器具
  - 屋内消火栓設備
  - 不良箇所一覧表
  - 避難器具
  - 誘導灯及び誘導標識
  - 非常警報器具及び設備
  - その他11種類
- **Word種類**: 点検票・報告書
  - tenkenhoukoku01~03.doc (点検報告書)
  - tenkenhyou01~36.doc (各種点検票)
  - 参考文書 (tenkenhoukoku_sankou.docx, tenkenhyou_sankou.doc)

### 必須項目
- 会社名
- 点検日
- 点検者名
- 各設備に対する点検結果
- 不良箇所の写真

### 出力方法
- メール送信(PDF/Excel/Word形式で添付)
- (将来的に)ハンディプリンタでの印刷

### 実装方針
- **第一フェーズ**: データ入力と簡易的なPDF出力
- **第二フェーズ**: ExcelテンプレートへのデータマッピングとExcel出力
- **第三フェーズ**: WordテンプレートへのデータマッピングとWord出力

## オフライン対応・データ同期

### オフライン時のデータ保存
PWAの特性を活かして、以下の方法でオフライン対応を実現:

- **LocalStorage**:
  - ブラウザに小容量(約5-10MB)のデータを保存
  - シンプルなキー・バリュー形式
  - 認証トークンなどの軽量データ保存に使用

- **IndexedDB**:
  - ブラウザに大容量のデータを保存可能
  - 構造化されたデータを保存
  - 点検データ、図面画像のキャッシュなどに使用

### 同期ロジック
- **複数ユーザーの同時編集**: 同一の点検ポイントに対して複数のユーザーがメモを記録可能
- **競合解決**:
  - 複数の記録がある場合は両方を保持し、黄色い△マークで表示
  - 報告書にも△マークを表示し、「競合が発生しています」と明示
  - 統合・確認作業が必要(手動でマージまたは選択)
- **オンライン復帰時**: 自動的にFirestoreと同期

### オフライン時の制限
- **利用可能な機能**:
  - 図面表示
  - 点検結果の手入力
  - 写真撮影(ローカル保存→オンライン復帰時に同期)
  - 設備配置(ローカル保存→オンライン復帰時に同期)
- **利用不可の機能**:
  - 音声入力(Gemini APIがオンライン必須)
  - 案件の新規作成・編集

## 認証・権限管理

### ユーザー認証
- **認証方法**: メールアドレス + パスワード
- **Firebase Authentication**を使用
- **デバイス識別**: MACアドレス相当の情報を記録

### アクセス制御
- **組織単位**: ユーザーは会社(組織)に所属
- **案件アクセス**: ログインした会社の案件のみアクセス可能
- **権限レベル**:
  - **管理者 (admin)**: 会社の全機能にアクセス可能
    - ユーザーの作成・編集・削除
    - 権限の付与・変更
    - 案件の作成・編集・削除
    - 全ての点検イベントへのアクセス
  - **点検者 (inspector)**: 点検業務に必要な機能のみ
    - 案件の閲覧
    - 点検イベントへの参加
    - 点検結果の入力・編集
    - 設備配置の追加・編集
  - **閲覧者 (viewer)**: 読み取り専用
    - 案件の閲覧
    - 点検結果の閲覧
    - 報告書の閲覧・ダウンロード

### ユーザー管理
- **ユーザー作成**: 管理者が会社のユーザーを作成
  - 管理者は複数人作成可能
  - 管理者は他の管理者を作成可能
- **初期パスワード**: 管理者が設定、初回ログイン時に変更を促す
- **招待フロー**: (将来的に)メール招待でユーザー登録

### 管理者の初期作成
- **最初の管理者**: 会社登録時に自動的に作成される
- **追加の管理者**: 既存の管理者が作成可能
- **管理者の削除**: 最低1人の管理者は必須 (最後の管理者は削除不可)

## 写真・添付ファイル

### 不良箇所の写真
- **撮影機能**: カメラ機能を使った写真撮影
- **保存先**: Firebase Cloud Storage
- **命名規則**: `photos/{projectId}/{eventId}/{pointId}/{timestamp}.jpg`
- **紐付け**: 点検結果データに写真のパスを保存

## Database

### 固定データ(マスターデータ)

#### `projects/{projectId}`
```javascript
{
  customerName: "〇〇ビル",
  address: "東京都...",
  companyId: "company123", // 所属会社ID
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### `projects/{projectId}/drawings/{drawingId}`
```javascript
{
  pdfName: "1F図面.pdf", // 元のPDFファイル名
  pdfStoragePath: "/drawings/projectId/drawingId.pdf", // 元PDFのパス
  pageNumber: 1, // このdrawingが何ページ目か
  displayOrder: 1, // 表示順序(PDF1-p1=1, PDF1-p2=2, PDF2-p1=3...)
  storagePath: "/drawings/projectId/drawingId_page1.png", // PNG変換後のパス
  createdAt: Timestamp
}
```

#### `projects/{projectId}/drawings/{drawingId}/points/{pointId}`
```javascript
{
  x: 150.5, // 図面上の座標
  y: 300.0, // 図面上の座標
  type: "heat_sensor", // 感知器の種類(18種類のいずれか)
  name: "感知器-1A",
  inspectionItems: [ // この設備固有の点検項目
    {
      itemName: "外観点検",
      required: true
    },
    {
      itemName: "作動点検",
      required: true
    },
    {
      itemName: "総合点検",
      required: false
    }
  ]
}
```

#### `equipmentTypes/` (設備種類マスター)
```javascript
{
  id: "heat_sensor",
  name: "熱感知器",
  iconColor: "#FF0000",
  inspectionItems: ["外観点検", "作動点検", "総合点検"],
  reportTemplate: "自動火災報知設備" // 対応する報告書テンプレート
}
```

### 変動データ(トランザクションデータ)

#### `projects/{projectId}/inspectionEvents/{eventId}`
```javascript
{
  year: 2025,
  status: "in_progress" | "completed",
  inspectorName: "田中",
  startDate: Timestamp,
  completedDate: Timestamp,
  participants: ["userId1", "userId2"] // 参加点検者のリスト
}
```
(この eventId が、その年の点検業務全体をまとめる親になります)

#### `projects/{projectId}/inspectionEvents/{eventId}/results/{pointId}`
```javascript
{
  status: "ok" | "fail" | "uninspected",
  records: [ // 複数ユーザーの記録を配列で保持
    {
      userId: "user123",
      userName: "田中",
      deviceId: "device-mac-address",
      inputMethod: "voice" | "manual", // 音声入力か手入力か
      itemResults: [ // 各点検項目の結果
        {
          itemName: "外観点検",
          status: "ok" | "fail",
          notes: "正常"
        },
        {
          itemName: "作動点検",
          status: "fail",
          notes: "ホコリあり、要清掃"
        }
      ],
      photos: [
        "/photos/projectId/eventId/pointId/timestamp1.jpg",
        "/photos/projectId/eventId/pointId/timestamp2.jpg"
      ],
      timestamp: Timestamp
    },
    {
      userId: "user456",
      userName: "佐藤",
      deviceId: "device-mac-address-2",
      inputMethod: "manual",
      itemResults: [
        {
          itemName: "外観点検",
          status: "ok",
          notes: "正常"
        },
        {
          itemName: "作動点検",
          status: "ok",
          notes: "正常"
        }
      ],
      photos: [],
      timestamp: Timestamp
    }
  ],
  hasConflict: true, // records.length > 1 の場合true
  isResolved: false, // 競合が解決されたかどうか
  lastUpdated: Timestamp
}
```

#### `users/{userId}`
```javascript
{
  email: "tanaka@example.com",
  name: "田中",
  companyId: "company123",
  role: "admin" | "inspector" | "viewer", // 権限レベル
  isActive: true, // アカウント有効/無効
  mustChangePassword: false, // 初回ログイン時にパスワード変更が必要か
  devices: [
    {
      deviceId: "device-mac-address",
      lastUsed: Timestamp
    }
  ],
  createdAt: Timestamp,
  createdBy: "userId", // 作成した管理者のID
  lastLogin: Timestamp
}
```

#### `companies/{companyId}`
```javascript
{
  name: "〇〇消防設備株式会社",
  address: "東京都...",
  adminUsers: ["userId1"], // 管理者ユーザーIDのリスト
  members: ["userId1", "userId2", "userId3"], // 全メンバー
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

## MVP(最初のリリース)の範囲

### 必須機能
1. **ログイン認証**
   - メールアドレス + パスワード
   - Firebase Authentication使用

2. **案件作成・編集**
   - 案件情報の登録・編集
   - 案件一覧表示

3. **PDF図面アップロード**
   - PDFファイルのアップロード
   - PDF.jsを使用したPNG変換
   - 複数PDFの連続表示

4. **図面表示とアイコン配置**
   - 図面上へのアイコン配置(設備編集モード)
   - 点検モード/設備配置モードの切り替え
   - パン・ズーム機能

5. **点検結果の手入力**
   - 各点検項目への手動入力
   - 正常/異常の選択
   - メモ欄への記入

6. **PDF出力**
   - 点検結果の簡易PDF出力
   - 会社名、点検日、点検者名などの基本情報を含む

7. **オフライン対応**
   - IndexedDBを使用したデータキャッシュ
   - オフライン時の手入力対応
   - オンライン復帰時の自動同期

8. **複数人同時編集**
   - 複数デバイスからの同時アクセス
   - リアルタイムデータ同期
   - 競合検出(黄色い△マーク表示)

### 今後の追加機能(MVP後)
- 音声入力(Gemini API連携)
- 写真撮影・添付
- Excel/Word形式での報告書出力
- 競合解決UI
- **ユーザー管理画面** (管理者によるユーザー作成・編集・削除)
- **詳細な権限制御** (admin/inspector/viewer の完全実装)
- メール招待機能
- データ分析・統計機能
- 監査ログ機能

### MVP での権限管理
MVP段階では、以下の簡易実装とする:
- ログイン認証のみ実装
- 全ユーザーを点検者として扱う
- ユーザー作成は Firebase Console で手動実施
- 本格的なユーザー管理画面は MVP 後に実装

## 非機能要件

### 対応デバイス
- **PC**: Windows、Mac (案件作成・図面アップロード用)
- **タブレット**: iPad、Android タブレット (点検作業用)
- **ブラウザ**: Safari、Chrome、Edge (最新版)
- **画面サイズ**:
  - PC: 1280x720以上
  - タブレット: 9インチ以上推奨
- **レスポンシブ対応**: PC、タブレット両対応

### データインポート
- **図面データ**: PDF形式でアップロード(自動的にPNGに変換)
- **設備配置**: 設備編集モードでアイコンを手動配置

### パフォーマンス
- **図面読み込み**: 3秒以内
- **点検データ同期**: 5秒以内
- **想定規模**:
  - 1建物あたり最大500点検ポイント
  - 1図面あたり最大100点検ポイント
